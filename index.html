<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>êµìœ¡í›ˆë ¨ ì ìˆ˜ ì¢…í•© ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; --accent: #27ae60; --bg-color: #f1f3f5;
            --disabled: #e9ecef; --danger: #e74c3c; --gold: #f39c12;
            --active-row: #f0f9ff; --score-low: #ff7f50; --score-high: #2ecc71; 
            --blue: #3498db; --setting-bg: #e2e8f0;
        }

        html, body { margin: 0; padding: 0; width: 100%; font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: var(--primary); display: flex; flex-direction: column; min-height: 100vh; }
        .container { width: 95%; max-width: 720px; margin: 15px auto; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        .top-header { padding: 25px 12px; border-bottom: 2px solid #f8f9fa; display: flex; flex-direction: column; align-items: center; }
        .title-area { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .top-logo { width: 55px; height: 55px; background-color: var(--primary); display: flex; align-items: center; justify-content: center; border-radius: 12px; color: white; font-size: 1.8rem; }
        h1 { margin: 0; font-size: 2.1rem; font-weight: 900; letter-spacing: -1.5px; color: #1a202c; white-space: nowrap; }
        
        .result-summary { width: 100%; max-width: 400px; background: var(--primary); padding: 20px; border-radius: 16px; color: white; text-align: center; box-sizing: border-box; }
        .total-score { font-size: 3.8rem; font-weight: 900; color: var(--score-low); margin: 0; line-height: 1; transition: color 0.4s; }
        .progress-container { width: 100%; background: rgba(255,255,255,0.2); height: 8px; border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--score-low); transition: width 0.5s; }

        .content-area { padding: 20px 8px; flex: 1; }
        .section-title { font-size: 1.1rem; font-weight: 800; margin: 25px 0 10px 5px; display: flex; align-items: center; gap: 8px; border-left: 4px solid var(--accent); padding-left: 10px; }
        
        .table-wrapper { width: 100%; overflow-x: auto; border: 1px solid #eee; border-radius: 14px; background: #fff; }
        table { width: 100%; border-collapse: collapse; min-width: 520px; }
        th { background: #fbfbfc; padding: 15px 5px; font-size: 0.85rem; border-bottom: 2px solid #edf2f7; color: #64748b; }
        td { padding: 12px 4px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        tr.active-row td { background-color: var(--active-row); }

        .score-input, .grade-select { height: 46px; padding: 0 8px; border: 2px solid #e2e8f0; border-radius: 10px; text-align: center; font-size: 0.95rem; box-sizing: border-box; transition: border-color 0.2s; }
        .score-input:focus, .grade-select:focus { border-color: var(--blue); outline: none; }
        .score-input { width: 75px; }
        .grade-select { width: 110px; background-color: #fff; }
        .max-point-label { font-size: 0.75rem; color: #95a5a6; display: block; margin-top: 4px; }

        .grade-badge { display: inline-block; padding: 5px 10px; border-radius: 6px; font-weight: 800; color: white; font-size: 0.8rem; background: #94a3b8; min-width: 45px; }
        .grade-íŠ¹ê¸‰ { background-color: var(--gold); }
        .grade-3ê¸‰ë¯¸ë§Œ, .grade-ë¶ˆí•©ê²© { background-color: var(--danger); }
        .grade-1ê¸‰, .grade-2ê¸‰, .grade-3ê¸‰ { background-color: #34495e; }

        .physical-calc-card { margin-top: 10px; padding: 18px; border: 2px solid var(--blue); border-radius: 16px; background-color: #f0f7ff; }
        .info-card { margin-top: 15px; padding: 18px; background: #f8fafc; border: 1px solid #e2e8f0; color: #475569; border-radius: 14px; font-size: 0.9rem; line-height: 1.6; }

        .action-area { padding: 20px 10px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; background: #fff; border-top: 1px solid #eee; }
        .btn { padding: 12px 20px; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }
        .reset-btn { background-color: #f1f2f6; color: #7f8c8d; }
        .save-btn { background-color: var(--primary); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); transition: all 0.2s; }

        /* ì„¤ì • íŒ¨ë„ */
        .settings-panel { margin: 20px 10px; padding: 0; background-color: var(--setting-bg); border-radius: 16px; overflow: hidden; border: 1px solid #cbd5e1; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; cursor: pointer; background: #e2e8f0; transition: background 0.2s; }
        .settings-header:hover { background: #d1d9e6; }
        .settings-title { font-weight: 800; color: #475569; display: flex; align-items: center; gap: 8px; }
        .settings-content { display: none; padding: 20px; background: #f8f9fa; }
        .settings-content.open { display: block; animation: slideDown 0.3s ease-out; }
        
        .setting-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .setting-group { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .setting-label { font-size: 0.85rem; font-weight: 700; margin-bottom: 12px; display: block; color: #64748b; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; }
        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.85rem; color: #2c3e50; font-weight: 600; }
        .setting-input { width: 60px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 6px; text-align: center; font-weight: bold; color: var(--primary); }

        @media (max-width: 500px) { .setting-grid { grid-template-columns: 1fr; } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        footer { text-align: center; padding: 30px 10px; font-size: 0.8rem; color: #94a3b8; background: #f1f5f9; }

        /* [ìˆ˜ì •ë¨] ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸°ìš©: í™”ë©´ ë’¤ë¡œ ìˆ¨ê¹€ (z-index) */
        #exportCardWrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 0; overflow: hidden; z-index: -1;
        }
        #exportCard {
            width: 500px; background: white; margin: 0; padding: 0;
            border: 1px solid #eee; font-family: 'Pretendard', sans-serif;
        }
        .card-header { background: var(--primary); color: white; padding: 35px 20px; text-align: center; }
        .card-body { padding: 35px; }
        .card-title { font-size: 2rem; font-weight: 900; margin: 0; letter-spacing: -1px; }
        .card-date { margin-top: 10px; opacity: 0.8; font-size: 0.95rem; }
        .card-score-area { text-align: center; margin: 25px 0 35px; padding: 25px; background: #f8f9fa; border-radius: 18px; border: 1px solid #edf2f7; }
        .card-total { font-size: 4.5rem; font-weight: 900; color: var(--primary); line-height: 1; letter-spacing: -2px; }
        .card-label { font-size: 1.1rem; color: #7f8c8d; margin-top: 8px; font-weight: 600; }
        .card-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .card-table th { background: #f1f2f6; color: #2c3e50; padding: 12px; text-align: center; border-bottom: 2px solid #ddd; font-weight: 700; }
        .card-table td { padding: 14px 10px; border-bottom: 1px solid #eee; text-align: center; color: #34495e; font-weight: 600; font-size: 1rem; }
        .card-footer { background: #ecf0f1; color: #7f8c8d; text-align: center; padding: 18px; font-size: 0.9rem; font-weight: 700; letter-spacing: -0.5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-header">
        <div class="title-area"><div class="top-logo">ğŸ–ï¸</div><h1>êµìœ¡í›ˆë ¨ ì ìˆ˜ ì¢…í•©</h1></div>
        <div class="result-summary">
            <div style="font-size: 0.9rem; opacity: 0.8;">êµìœ¡í›ˆë ¨ í™˜ì‚° ì ìˆ˜ (70ì  ë§Œì )</div>
            <div id="totalDisplay" class="total-score">0.00</div>
            <div style="font-size: 0.85rem; opacity: 0.7;">/ 70.00 ì </div>
            <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
        </div>
    </div>

    <div class="content-area">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th width="20%">ê³¼ëª©ëª…</th><th width="22%">ì ìˆ˜ ì…ë ¥</th><th width="23%">ë“±ê¸‰ ì„ íƒ</th><th width="15%">íŒì •</th><th width="20%">í™˜ì‚°ì ìˆ˜</th></tr>
                </thead>
                <tbody id="scoreTableBody"></tbody>
            </table>
        </div>

        <div class="section-title">ğŸƒ ê¸°ì´ˆì²´ë ¥ ì„¸ë¶€ ë“±ê¸‰ ê³„ì‚°ê¸°</div>
        <div class="physical-calc-card">
            <table style="min-width: 100%; background: transparent; border: none;">
                <tbody style="border: none;">
                    <tr style="background: transparent;">
                        <td>ë‹¬ë¦¬ê¸°</td>
                        <td><select id="runG" class="grade-select" onchange="calcPhys(true)"><option value="0">ì„ íƒ</option><option value="10">íŠ¹ê¸‰(10)</option><option value="8">1ê¸‰(8)</option><option value="6">2ê¸‰(6)</option><option value="4">3ê¸‰(4)</option><option value="0">3ê¸‰ë¯¸ë§Œ(0)</option></select></td>
                        <td>íŒ”êµ½í˜€í´ê¸°</td>
                        <td><select id="pushG" class="grade-select" onchange="calcPhys(true)"><option value="0">ì„ íƒ</option><option value="5">íŠ¹ê¸‰(5)</option><option value="4">1ê¸‰(4)</option><option value="3">2ê¸‰(3)</option><option value="2">3ê¸‰(2)</option><option value="0">3ê¸‰ë¯¸ë§Œ(0)</option></select></td>
                    </tr>
                    <tr style="background: transparent;">
                        <td>ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°</td>
                        <td><select id="sitG" class="grade-select" onchange="calcPhys(true)"><option value="0">ì„ íƒ</option><option value="5">íŠ¹ê¸‰(5)</option><option value="4">1ê¸‰(4)</option><option value="3">2ê¸‰(3)</option><option value="2">3ê¸‰(2)</option><option value="0">3ê¸‰ë¯¸ë§Œ(0)</option></select></td>
                        <td colspan="2" style="text-align: right; font-weight: 800;">í•©ê³„: <span id="physSumDisplay">0</span>ì </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="settings-panel">
            <div class="settings-header" onclick="toggleSettings()">
                <div class="settings-title">âš™ï¸ ê´€ë¦¬ì ì„¤ì • (ë°°ì  ë° ë¹„ìœ¨ ë³€ê²½)</div>
                <div id="settingArrow">â–¼</div>
            </div>
            <div id="settingsContent" class="settings-content">
                <div class="setting-grid">
                    <div class="setting-group">
                        <span class="setting-label">ë“±ê¸‰ë³„ ì¸ì • ë¹„ìœ¨ (%)</span>
                        <div id="ratioInputs"></div>
                    </div>
                    <div class="setting-group">
                        <span class="setting-label">ê³¼ëª©ë³„ ë§Œì  ë°°ì </span>
                        <div id="subjectInputs"></div>
                    </div>
                </div>
                <div style="margin-top: 20px; display:flex; justify-content:center; gap:10px;">
                    <button class="btn" style="background:#95a5a6; color:white; font-size:0.85rem;" onclick="resetSettings()">ğŸ”„ ì„¤ì • ì´ˆê¸°í™”</button>
                    <button class="btn save-btn" onclick="saveSettings()">ğŸ’¾ ì„¤ì • ì €ì¥ ë° ì ìš©</button>
                </div>
            </div>
        </div>

        <div class="info-card">
            <strong>ğŸ’¡ ìë™ ê³„ì‚° ë° ì €ì¥</strong><br>
            â€¢ ê³¼ëª©ë³„ ë°°ì ì— ë“±ê¸‰ ë¹„ìœ¨ì„ ê³±í•˜ì—¬ <b>ìë™ìœ¼ë¡œ ì ìˆ˜ê°€ ì‚°ì¶œ</b>ë©ë‹ˆë‹¤.<br>
            â€¢ ëª¨ë“  ì…ë ¥ ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— <b>ìë™ ì €ì¥</b>ë©ë‹ˆë‹¤.
        </div>
    </div>

    <div class="action-area">
        <button class="btn reset-btn" onclick="resetAll()">ğŸ—‘ï¸ ì…ë ¥ ì´ˆê¸°í™”</button>
        <button class="btn save-btn" onclick="downloadImage()">ğŸ“¸ ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
</div>

<footer>ë¬¸ì˜ : êµ­êµ°ìˆ˜ì†¡ì‚¬ë ¹ë¶€ êµìœ¡ì¥êµ</footer>

<div id="exportCardWrapper">
    <div id="exportCard">
        <div class="card-header">
            <h2 class="card-title">ğŸ–ï¸ êµìœ¡í›ˆë ¨ í‰ê°€ ê²°ê³¼</h2>
            <div class="card-date" id="cardDate"></div>
        </div>
        <div class="card-body">
            <div class="card-score-area">
                <div class="card-label">ìµœì¢… í™˜ì‚° ì ìˆ˜</div>
                <div class="card-total" id="cardTotalScore">0.00</div>
                <div class="card-label">/ 70.00 ë§Œì </div>
            </div>
            <table class="card-table">
                <thead><tr><th width="35%">í‰ê°€ ê³¼ëª©</th><th width="30%">íšë“ ë“±ê¸‰</th><th width="35%">í™˜ì‚° ì ìˆ˜</th></tr></thead>
                <tbody id="cardTableBody"></tbody>
            </table>
        </div>
        <div class="card-footer">êµ­êµ°ìˆ˜ì†¡ì‚¬ë ¹ë¶€ êµìœ¡í›ˆë ¨ ì ìˆ˜ ì¢…í•© ì‹œìŠ¤í…œ</div>
    </div>
</div>

<script>
    // 1. ê¸°ë³¸ê°’ ìƒìˆ˜ (ì´ˆê¸°í™” ì‹œ ë³µêµ¬ìš©)
    const DEFAULT_RATIOS = { "íŠ¹ê¸‰": 1.0, "1ê¸‰": 0.929, "2ê¸‰": 0.858, "3ê¸‰": 0.786, "3ê¸‰ ë¯¸ë§Œ": 0.572, "ë¶ˆí•©ê²©": 0.429 };
    // [ë³´ì™„] type ì†ì„± ì¶”ê°€ë¡œ ì‹ë³„ì„± ê°•í™”
    const DEFAULT_SUBJECTS = [
        { name: "ì •ì‹ ì „ë ¥", max: 10, type: "general" },
        { name: "ê¸°ì´ˆì²´ë ¥", max: 10, type: "physical" },
        { name: "ì‚¬ê²©", max: 10, type: "shooting" },
        { name: "í•µ ë° í™”ìƒë°©", max: 5, type: "general" },
        { name: "TCCC", max: 5, type: "general" },
        { name: "ì£¼íŠ¹ê¸°", max: 30, type: "general" }
    ];

    let currentRatios = { ...DEFAULT_RATIOS };
    let currentSubjects = JSON.parse(JSON.stringify(DEFAULT_SUBJECTS));

    // 2. ì´ˆê¸°í™” ì‹¤í–‰
    function init() {
        loadSettingsFromStorage();
        renderMainTable();
        renderSettingsPanel();
        loadScoreDataFromStorage();
    }

    // --- ì„¤ì • ê´€ë¦¬ (LocalStorage) ---
    function loadSettingsFromStorage() {
        const saved = localStorage.getItem('militarySettings');
        if (saved) {
            const parsed = JSON.parse(saved);
            currentRatios = parsed.ratios;
            currentSubjects = parsed.subjects;
        }
    }

    function saveSettings() {
        // ìœ íš¨ì„± ê²€ì‚¬ ë° ì €ì¥
        Object.keys(currentRatios).forEach(key => {
            const input = document.getElementById(`ratio_input_${key}`);
            if(input) {
                let val = parseFloat(input.value);
                if(val < 0) val = 0; if(val > 100) val = 100; // 0~100 ë²”ìœ„ ì œí•œ
                currentRatios[key] = val / 100;
            }
        });

        currentSubjects.forEach((sub, idx) => {
            const input = document.getElementById(`subject_input_${idx}`);
            if(input) sub.max = Math.max(0, parseFloat(input.value)); // ìŒìˆ˜ ë°©ì§€
        });

        localStorage.setItem('militarySettings', JSON.stringify({ ratios: currentRatios, subjects: currentSubjects }));
        
        alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        renderMainTable();
        // ê¸°ì¡´ ì…ë ¥ê°’ ì¬ê³„ì‚° íŠ¸ë¦¬ê±°
        currentSubjects.forEach((_, idx) => {
            const input = document.getElementById(`input_${idx}`);
            if(input && input.value) handleInput(idx, false);
            else {
                const sel = document.getElementById(`select_${idx}`);
                if(sel && sel.value) applyResult(idx, sel.value);
            }
        });
        toggleSettings();
    }

    function resetSettings() {
        if(confirm("ë°°ì  ë° ë¹„ìœ¨ ì„¤ì •ì„ ì´ˆê¸°ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('militarySettings');
            currentRatios = { ...DEFAULT_RATIOS };
            currentSubjects = JSON.parse(JSON.stringify(DEFAULT_SUBJECTS));
            renderSettingsPanel();
            renderMainTable();
            renderMainTable(); // UI ê°±ì‹ 
            alert("ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    // --- ë Œë”ë§ ---
    function renderMainTable() {
        const tbody = document.getElementById('scoreTableBody');
        // ê°’ ìœ ì§€ ë¡œì§
        const oldData = {};
        currentSubjects.forEach((_, idx) => {
            const i = document.getElementById(`input_${idx}`);
            const s = document.getElementById(`select_${idx}`);
            if(i) oldData[idx] = { val: i.value, type: 'input' };
            else if(s) oldData[idx] = { val: s.value, type: 'select' };
        });

        tbody.innerHTML = '';
        currentSubjects.forEach((sub, idx) => {
            const isPhys = sub.type === "physical";
            const isShoot = sub.type === "shooting";
            const row = document.createElement('tr');
            row.id = `row_${idx}`;
            
            row.innerHTML = `
                <td><b>${sub.name}</b><span class="max-point-label">(${sub.max}ì )</span></td>
                <td>${isPhys ? `<span style="font-size:0.8rem; color:var(--blue)">í•˜ë‹¨ ê³„ì‚°ê¸° ì´ìš©</span>` : 
                    `<input type="number" class="score-input" id="input_${idx}" oninput="handleInput(${idx}, true)" placeholder="0-${isShoot?'20':'100'}">`}</td>
                <td>
                    <select class="grade-select" id="select_${idx}" onchange="handleSelect(${idx}, true)" ${isPhys ? 'disabled' : ''}>
                        <option value="">ì„ íƒ</option>
                        ${Object.keys(currentRatios).map(r => `<option value="${r}">${r}</option>`).join('')}
                    </select>
                </td>
                <td><span id="grade_${idx}" class="grade-badge">-</span></td>
                <td><span id="point_${idx}" class="display-point">0.00</span></td>
            `;
            tbody.appendChild(row);
        });

        // ê°’ ë³µì›
        Object.keys(oldData).forEach(idx => {
            if(oldData[idx].val) {
                if(oldData[idx].type === 'input') {
                    document.getElementById(`input_${idx}`).value = oldData[idx].val;
                    handleInput(idx, false);
                } else {
                    document.getElementById(`select_${idx}`).value = oldData[idx].val;
                    const inp = document.getElementById(`input_${idx}`);
                    if(inp) inp.disabled = true;
                    applyResult(idx, oldData[idx].val);
                }
            }
        });
    }

    function renderSettingsPanel() {
        const rBox = document.getElementById('ratioInputs');
        rBox.innerHTML = Object.keys(currentRatios).map(key => `
            <div class="input-row"><span>${key}</span><div><input type="number" id="ratio_input_${key}" class="setting-input" value="${(currentRatios[key]*100).toFixed(1)}"> %</div></div>
        `).join('');

        const sBox = document.getElementById('subjectInputs');
        sBox.innerHTML = currentSubjects.map((sub, idx) => `
            <div class="input-row"><span>${sub.name}</span><div><input type="number" id="subject_input_${idx}" class="setting-input" value="${sub.max}"> ì </div></div>
        `).join('');
    }

    function toggleSettings() {
        const content = document.getElementById('settingsContent');
        const arrow = document.getElementById('settingArrow');
        if (content.classList.contains('open')) {
            content.classList.remove('open');
            arrow.innerText = "â–¼";
        } else {
            content.classList.add('open');
            arrow.innerText = "â–²";
        }
    }

    // --- ê³„ì‚° ë¡œì§ ---
    function calculateScore(maxScore, grade) {
        if (!grade || currentRatios[grade] === undefined) return 0;
        return Math.ceil(maxScore * currentRatios[grade] * 100) / 100; // 3ì§¸ìë¦¬ ì˜¬ë¦¼
    }

    function calcPhys(save = false) {
        const sum = parseInt(document.getElementById('runG').value) + parseInt(document.getElementById('pushG').value) + parseInt(document.getElementById('sitG').value);
        document.getElementById('physSumDisplay').innerText = sum;
        
        let grade = "ë¶ˆí•©ê²©";
        if (sum >= 20) grade = "íŠ¹ê¸‰";
        else if (sum >= 16) grade = "1ê¸‰";
        else if (sum >= 12) grade = "2ê¸‰";
        else if (sum >= 8) grade = "3ê¸‰";
        else if (sum >= 1) grade = "3ê¸‰ ë¯¸ë§Œ";
        
        // ê¸°ì´ˆì²´ë ¥(physical íƒ€ì…) ì°¾ì•„ì„œ ë°˜ì˜
        const physIdx = currentSubjects.findIndex(s => s.type === "physical");
        if(physIdx >= 0) {
            applyResult(physIdx, grade);
            document.getElementById(`select_${physIdx}`).value = grade;
        }
        if(save) saveScoreData();
    }

    function handleInput(idx, save = false) {
        const inputEl = document.getElementById(`input_${idx}`);
        const selectEl = document.getElementById(`select_${idx}`);
        const val = parseFloat(inputEl.value);
        const type = currentSubjects[idx].type;

        if (isNaN(val)) { 
            selectEl.disabled = false; applyResult(idx, ""); 
        } else {
            selectEl.disabled = true;
            let grade = "ë¶ˆí•©ê²©";
            // [ë³´ì™„] ê³¼ëª© ì´ë¦„ ëŒ€ì‹  typeìœ¼ë¡œ í™•ì¸í•˜ì—¬ ì•ˆì •ì„± í™•ë³´
            if (type === "shooting") {
                if (val >= 18) grade = "íŠ¹ê¸‰"; else if (val >= 16) grade = "1ê¸‰"; else if (val >= 14) grade = "2ê¸‰"; else if (val >= 12) grade = "3ê¸‰"; else if (val >= 1) grade = "3ê¸‰ ë¯¸ë§Œ";
            } else {
                if (val >= 90) grade = "íŠ¹ê¸‰"; else if (val >= 80) grade = "1ê¸‰"; else if (val >= 70) grade = "2ê¸‰"; else if (val >= 60) grade = "3ê¸‰"; else if (val > 0) grade = "3ê¸‰ ë¯¸ë§Œ";
            }
            applyResult(idx, grade);
        }
        if(save) saveScoreData();
    }

    function handleSelect(idx, save = false) {
        const inputEl = document.getElementById(`input_${idx}`);
        const selectEl = document.getElementById(`select_${idx}`);
        if (selectEl.value !== "") { 
            if(inputEl) inputEl.disabled = true; applyResult(idx, selectEl.value); 
        } else { 
            if(inputEl) inputEl.disabled = false; applyResult(idx, ""); 
        }
        if(save) saveScoreData();
    }

    function applyResult(idx, grade) {
        const maxScore = currentSubjects[idx].max;
        const point = calculateScore(maxScore, grade);
        
        document.getElementById(`grade_${idx}`).innerText = grade || "-";
        document.getElementById(`grade_${idx}`).className = `grade-badge ${grade ? 'grade-' + grade.replace(" ", "") : ""}`;
        document.getElementById(`point_${idx}`).innerText = point.toFixed(2);
        
        const row = document.getElementById(`row_${idx}`);
        if(grade) row.classList.add('active-row'); else row.classList.remove('active-row');
        calculateTotal();
    }

    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('.display-point').forEach(p => { total += parseFloat(p.innerText); });
        const disp = document.getElementById('totalDisplay');
        disp.innerText = total.toFixed(2);
        const color = total >= 60 ? "#2ecc71" : "#ff7f50";
        disp.style.color = color;
        document.getElementById('progressBar').style.width = Math.min((total / 70 * 100), 100) + "%";
        document.getElementById('progressBar').style.background = color;
    }

    // --- ë°ì´í„° ì €ì¥/ë¡œë“œ (ì‚¬ìš©ì ì ìˆ˜) ---
    function saveScoreData() {
        const data = {
            inputs: [], selects: [],
            phys: { run: document.getElementById('runG').value, push: document.getElementById('pushG').value, sit: document.getElementById('sitG').value }
        };
        currentSubjects.forEach((_, idx) => {
            const i = document.getElementById(`input_${idx}`);
            const s = document.getElementById(`select_${idx}`);
            data.inputs.push(i ? i.value : "");
            data.selects.push(s ? s.value : "");
        });
        localStorage.setItem('militaryScoreData', JSON.stringify(data));
    }

    function loadScoreDataFromStorage() {
        const saved = localStorage.getItem('militaryScoreData');
        if (!saved) return;
        const data = JSON.parse(saved);
        if(data.phys) {
            document.getElementById('runG').value = data.phys.run;
            document.getElementById('pushG').value = data.phys.push;
            document.getElementById('sitG').value = data.phys.sit;
            calcPhys(false);
        }
        currentSubjects.forEach((_, idx) => {
            const i = document.getElementById(`input_${idx}`);
            const s = document.getElementById(`select_${idx}`);
            if (i && data.inputs[idx]) { i.value = data.inputs[idx]; handleInput(idx, false); }
            else if (s && data.selects[idx]) { s.value = data.selects[idx]; handleSelect(idx, false); }
        });
    }

    function resetAll() {
        if(confirm("ì…ë ¥í•œ ì ìˆ˜ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê´€ë¦¬ì ì„¤ì •ì€ ìœ ì§€ë¨)")) {
            localStorage.removeItem('militaryScoreData');
            location.reload();
        }
    }

    // --- ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° (ìˆ˜ì •ë¨: html2canvas ë²„ê·¸ ë°©ì§€) ---
    function downloadImage() {
        const today = new Date();
        document.getElementById('cardDate').innerText = `${today.getFullYear()}. ${today.getMonth()+1}. ${today.getDate()}`;
        document.getElementById('cardTotalScore').innerText = document.getElementById('totalDisplay').innerText;
        const tbody = document.getElementById('cardTableBody');
        tbody.innerHTML = '';
        
        currentSubjects.forEach((sub, idx) => {
            const grade = document.getElementById(`grade_${idx}`).innerText;
            const point = document.getElementById(`point_${idx}`).innerText;
            if(grade !== "-") {
                tbody.innerHTML += `<tr><td>${sub.name}</td><td style="color:var(--primary)">${grade}</td><td>${point}</td></tr>`;
            }
        });

        if(tbody.innerHTML === '') { alert("ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        
        const card = document.getElementById('exportCard');
        html2canvas(card, { scale: 2, useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = `êµìœ¡í›ˆë ¨í‰ê°€_${today.toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }).catch(err => {
            console.error(err);
            alert("ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }

    window.onload = init;
</script>
</body>
</html>
